# Adaptive Task Space Control
<p align="center">
    <img align="center" src="https://user-images.githubusercontent.com/38805251/268449315-614a213d-ad61-4f85-a576-136343012022.png" width="230" height="150">
</p>



This study primarily concentrates on enhancing the feedback gains employed in task-space control of legged robots, specifically for the floating-base task. The selection of optimal feedback gains directly correlates with improved tracking performance in locomotion. This paper presents a novel approach that involves the utilization of a well-suited template model and sensitivity analysis to calculate state-dependent feedback gains for the floating-base task. The effectiveness of the proposed feedback gains is demonstrated through extensive simulations conducted in MuJoCo, as well as real-world experiments conducted on the Aliengo robot, showcasing remarkable enhancements in tracking performance.



# Build Package
Download QP solve from [proxsuite](https://github.com/Simple-Robotics/proxsuite) to `src/third_parties`
```bash
git clone --recursive https://github.com/Simple-Robotics/proxsuite
```
Install dependence 
```bash
sudo apt-get install libmatio-dev libsimde-dev
```

create `build` folder and then use CMake Tools to build this package

```bash
cd ${source folder} & bash build.sh
echo "source ${source folder}/install/setup.bash" >> ~/.bashrc
```



# Run Package

## Simulation
The simulator is based on a open-source platform [MuJoCo](https://mujoco.org/). Compared to other physics engine, it has great advantages of accurancy and computational efficiency. one can start the simulator by
```bash
ros2 launch sim sim_launch.py 
```
And then one can use `ros2 topic list` and `ros2 topic echo ${topic_name}` to check the topics
```bash
/parameter_events
/rosout
/simulation/actuators_cmds
/simulation/imu_data
/simulation/joint_states
/simulation/odom
/simulation/touch_sensor
```
One can also choose own robot to simulate by modifying the following two lines in `src/sim/launch/sim_launch.py`
```python
config_file_name = "aliengo/config.yaml"
config_file = os.path.join(get_package_share_path("asserts"), config_file_name)
```





## Estimator
Coding Reference [Cheetah-Software](https://github.com/mit-biomimetics/Cheetah-Software). In this package, the estimator is currently suitable for the flat-ground case where assume the foot tourching the ground has zero height and the contact detection is replaced by predefined gait timing. The futural work can be extended to learning-based contact detection and position-free control framework where only accurate velocity estimation is required in controller level. One can start the estimator by
```bash
ros2 launch estimation estimator_launch.py
```
And then a new topic called `/${topic_prefix}/estimated_states` is published. Now a structural graph can be generated by `rqt_graph`
<p align="center">
    <img align="center" src="https://user-images.githubusercontent.com/38805251/268480551-0ddfb4ba-db67-44ea-aab5-e0a4efb72a93.png" width="800">
</p>


## Controller





# package development

Download the package MuJoCo to the folder `src/third_parties/mujocodl` and then delete the `main.cc` in  the folder `src/third_parties/mujocodl/mujoco/simulate`. Besides, copy the library file `src/third_parties/mujocodl/mujoco/lib/libmujoco.so.2.3.7` to /usr/lib and use the follolwing commands to make links
``` bash
sudo ln -s /usr/lib/libmujoco.so.2.3.7 /usr/lib/libmujoco.so
```
When you instance a `shared_ptr` using `make_shared` in `rclcpp::Node` construction function, please note that there is function with the same name called `make_shared` for `rclcpp::Node`. Hence, write as `std::make_shared` for other shared pointers.

Besides, the actuator names in `*.xml` model file should be the same as the joints' names:
```xml
<actuator>
        <motor name="FL_hip_joint" gear="1" joint="FL_hip_joint" />
        <motor name="FL_thigh_joint" gear="1" joint="FL_thigh_joint" />
        ......
    </actuator>
```



If  the following errors appear when building the package:

```
Imported target "pinocchio_interface::pinocchio_interface" includes non-existent path
```

Just rebuild but do not clean the built files.

```
undefined reference to `ament_index_cpp::get_package_share_directory(std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > const&)'
```

For the above error, `ament_index_cpp` package dependence should be added to the `package.xml` and `CMakeLists.txt`.


If the required name in `*.cpp` is not defined in a config yaml file, the following error will occur.
```
terminate called after throwing an instance of 'YAML::TypedBadConversion<std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > >'
```

**Note:** Use `float64` when you define your own message.

# data recording

One can use the following commands to record the all datas
``` bash
ros2 bag record --all
```
and replay by
``` bash
ros2 bag play ${bag_name}
```

